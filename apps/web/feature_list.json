{
  "project_name": "MedSync Front",
  "description": "Sistema de gestão médica - Frontend",
  "tech_stack": [
    "Next.js 16",
    "React 19",
    "TypeScript",
    "Tailwind CSS 4",
    "Supabase",
    "React Hook Form",
    "Zod",
    "Radix UI",
    "shadcn/ui",
    "Lucide React",
    "Recharts",
    "date-fns",
    "next-themes",
    "jsPDF",
    "html2canvas",
    "Sonner"
  ],
  "features": [
    {
      "id": "F001",
      "title": "Create address database schema and migration",
      "type": "feature",
      "description": "Expand Supabase database schema to include comprehensive address fields for clinics/hospitals. Create new table 'facility_addresses' with fields: facility_id (FK), street, number, complement, neighborhood, city, state, postal_code, country, latitude, longitude, created_at, updated_at. Add foreign key relationship to facilities table. Create and apply migration.",
      "acceptance_criteria": [
        "facility_addresses table created with all required fields",
        "Foreign key relationship established with facilities table",
        "Migration file created and successfully applied to Supabase",
        "Latitude and longitude fields configured as numeric types",
        "Indexes created for facility_id and location queries"
      ],
      "passes": true
    },
    {
      "id": "F002",
      "title": "Create address Zod validation schema",
      "type": "feature",
      "description": "Create comprehensive Zod validation schema for facility addresses in schemas/facility-address.schema.ts. Include validation for all address fields with Brazilian address patterns (CEP format, state abbreviations). Add optional latitude/longitude validation. Export schema types for TypeScript usage throughout the application.",
      "acceptance_criteria": [
        "Zod schema created in schemas/facility-address.schema.ts",
        "CEP validation implemented with regex pattern (XXXXX-XXX)",
        "Brazilian state abbreviations validated against enum",
        "Latitude/longitude validated as optional numeric values within valid ranges",
        "TypeScript types exported for use in forms and API"
      ],
      "passes": true
    },
    {
      "id": "F003",
      "title": "Implement facility address API endpoints",
      "type": "feature",
      "description": "Create API routes for facility address CRUD operations. Implement POST /api/facilities/[id]/address, PATCH /api/facilities/[id]/address, and GET /api/facilities/[id]/address. Add Zod validation, error handling, and Supabase integration. Include RLS policies for organization-level access control.",
      "acceptance_criteria": [
        "API routes created for POST, PATCH, and GET operations",
        "Zod schema validation applied to all request bodies",
        "Supabase queries implemented with proper error handling",
        "RLS policies configured for organization-level data isolation",
        "Appropriate HTTP status codes returned for all scenarios"
      ],
      "passes": true
    },
    {
      "id": "F004",
      "title": "Install and configure Leaflet.js for maps",
      "type": "feature",
      "description": "Install react-leaflet and leaflet packages. Configure Leaflet CSS imports in globals.css. Create TypeScript type declarations for Leaflet if needed. Set up basic map configuration with default center coordinates (Brazil center). Create base MapContainer wrapper component in components/molecules with proper Next.js dynamic import to avoid SSR issues.",
      "acceptance_criteria": [
        "react-leaflet and leaflet packages installed via npm",
        "Leaflet CSS imported and styled correctly in globals.css",
        "MapContainer wrapper component created with dynamic import",
        "Default map configuration set to Brazil's geographic center",
        "Component renders correctly without SSR hydration errors"
      ],
      "passes": true
    },
    {
      "id": "F005",
      "title": "Create AddressFormFields component with all address inputs",
      "type": "feature",
      "description": "Build comprehensive AddressFormFields component in components/molecules using React Hook Form integration. Include inputs for street, number, complement, neighborhood, city, state (dropdown), postal_code (with mask), and country. Implement CEP auto-complete using ViaCEP API. Apply Zod validation schema. Follow existing form patterns in the project.",
      "acceptance_criteria": [
        "AddressFormFields component created with all required input fields",
        "React Hook Form integration implemented with proper typing",
        "Brazilian state dropdown populated with all 27 states",
        "CEP input mask applied (XXXXX-XXX format)",
        "ViaCEP API integration auto-fills address fields on valid CEP"
      ],
      "passes": true
    },
    {
      "id": "F006",
      "title": "Create interactive LocationPicker map component",
      "type": "feature",
      "description": "Build LocationPicker component in components/molecules using Leaflet.js. Implement click-to-place marker functionality to set latitude/longitude. Add drag marker feature to adjust location. Include search box for address lookup with geocoding. Display current coordinates. Integrate with React Hook Form to update latitude/longitude fields. Add responsive design for mobile devices.",
      "acceptance_criteria": [
        "LocationPicker component created with Leaflet map integration",
        "Click-to-place marker functionality working correctly",
        "Marker dragging updates latitude/longitude in real-time",
        "Geocoding search box implemented for address lookup",
        "Component integrates with React Hook Form setValue/watch"
      ],
      "passes": true
    },
    {
      "id": "F007",
      "title": "Integrate address form into facility creation flow",
      "type": "feature",
      "description": "Update facility creation form to include AddressFormFields and LocationPicker components. Modify facility.schema.ts to include address validation. Update form submission logic to save address data via API. Ensure proper form state management and error handling. Add loading states during address save operations.",
      "acceptance_criteria": [
        "AddressFormFields component integrated into facility creation form",
        "LocationPicker component added with proper spacing and layout",
        "Form submission saves complete address data including geolocation",
        "Error messages displayed for address validation failures",
        "Loading states shown during API calls"
      ],
      "passes": true
    },
    {
      "id": "F008",
      "title": "Integrate address form into facility edit flow",
      "type": "feature",
      "description": "Update facility edit form to load existing address data and populate AddressFormFields and LocationPicker. Implement PATCH API call to update address. Handle cases where facility has no existing address (create new). Pre-populate map marker with existing latitude/longitude. Add confirmation for location changes.",
      "acceptance_criteria": [
        "Existing address data loaded and populated in form fields",
        "Map marker positioned at existing coordinates on load",
        "PATCH API updates address when editing existing facility",
        "New address created if facility has no existing address",
        "All form fields editable with proper validation"
      ],
      "passes": true
    },
    {
      "id": "F009",
      "title": "Create facility location display component for read-only views",
      "type": "feature",
      "description": "Build FacilityLocationDisplay component in components/molecules to show complete address and map in read-only mode. Display formatted address with all fields. Show static Leaflet map with marker at facility location. Add 'Open in Google Maps' link. Use in facility detail views and lists. Implement responsive design.",
      "acceptance_criteria": [
        "FacilityLocationDisplay component created for read-only views",
        "Complete address displayed in formatted, readable layout",
        "Static map rendered with marker at correct coordinates",
        "Google Maps link opens facility location in new tab",
        "Component responsive on mobile and desktop devices"
      ],
      "passes": true
    },
    {
      "id": "F010",
      "title": "Add migration to populate existing facilities with default address",
      "type": "feature",
      "description": "Create data migration script to handle existing facilities with old text-based address field. Parse existing address text into structured format where possible. Create facility_addresses records for all existing facilities. Add flag to indicate auto-migrated vs user-entered addresses. Log migration results and handle edge cases.",
      "acceptance_criteria": [
        "Migration script created to process existing facilities",
        "Old text address field parsed and mapped to new structure",
        "facility_addresses records created for all existing facilities",
        "Migration logs created showing success/failure counts",
        "Edge cases handled gracefully with fallback values"
      ],
      "passes": true
    },
    {
      "id": "F011",
      "title": "Create Supabase RPC function for dashboard report metrics",
      "type": "feature",
      "description": "Create PostgreSQL function 'reports_dashboard_metrics' that aggregates real data from shifts, medical_staff, facilities, and payment_records tables. Function should accept parameters: p_period (text), p_specialty (text), p_unit (text/uuid). Return structure must match ReportMetricsBundle interface with summary metrics, specialty trends, efficiency trends, financial trends, and highlights based on actual database data.",
      "acceptance_criteria": [
        "PostgreSQL function reports_dashboard_metrics created with correct signature",
        "Function queries shifts table grouped by date for trend data",
        "Function calculates attendance volume from shifts by specialty",
        "Function calculates financial metrics from payment_records table",
        "Function returns JSON structure matching ReportMetricsBundle TypeScript interface"
      ],
      "passes": true
    },
    {
      "id": "F012",
      "title": "Implement specialty-based filtering in report metrics",
      "type": "feature",
      "description": "Extend reports_dashboard_metrics RPC function to filter data by medical staff specialty. Query medical_staff table to filter shifts by staff specialty field. Handle 'todas' (all) option to return aggregated data across all specialties. Ensure specialty trend chart data is correctly filtered and grouped.",
      "acceptance_criteria": [
        "RPC function filters shifts by medical_staff.specialty when p_specialty != 'todas'",
        "Specialty parameter properly joins shifts with medical_staff table",
        "Returns aggregated data for all specialties when p_specialty = 'todas'",
        "Specialty trend data correctly reflects filtered results",
        "Handles NULL specialty values gracefully"
      ],
      "passes": true
    },
    {
      "id": "F013",
      "title": "Implement facility-based filtering in report metrics",
      "type": "feature",
      "description": "Extend reports_dashboard_metrics RPC function to filter data by facility (unit). Query facilities table and filter shifts by facility_id. Handle 'todas' (all) option to return data across all facilities. Update highlights section to show top performers filtered by selected facility.",
      "acceptance_criteria": [
        "RPC function filters shifts by facility_id when p_unit != 'todas'",
        "Facility parameter properly joins shifts with facilities table",
        "Returns aggregated data for all facilities when p_unit = 'todas'",
        "Highlights data reflects facility filtering",
        "Validates facility_id exists in facilities table"
      ],
      "passes": true
    },
    {
      "id": "F014",
      "title": "Calculate real summary metrics from database",
      "type": "feature",
      "description": "Implement summary metrics calculation in reports_dashboard_metrics function: total attendances from shifts count, average occupancy rate from shift_attendance, revenue from payment_records.total_amount sum, denial rate from payment_records. Calculate period-over-period deltas comparing current period with previous period of same length.",
      "acceptance_criteria": [
        "Total attendances calculated from shifts table count for period",
        "Occupancy rate calculated from shift_attendance check-in/check-out data",
        "Revenue sum calculated from payment_records.total_amount",
        "Denial/glosa rate calculated from payment_records metadata or status",
        "Delta percentages calculated comparing current vs previous period"
      ],
      "passes": true
    },
    {
      "id": "F015",
      "title": "Generate specialty trend time series from shifts data",
      "type": "feature",
      "description": "Implement specialty trend chart data generation in RPC function. Query shifts joined with medical_staff, group by date and specialty. Generate time series data points with labels and counts for each specialty (geral, cardiologia, pediatria, etc). Handle dynamic date range based on period parameter (7d, 30d, 90d, 180d).",
      "acceptance_criteria": [
        "Shifts grouped by date using date_trunc based on period length",
        "Data joined with medical_staff to get specialty field",
        "Returns array of points with label and count per specialty",
        "Handles all period options: 7d, 30d, 90d, 180d correctly",
        "Date labels formatted appropriately for chart display"
      ],
      "passes": true
    },
    {
      "id": "F016",
      "title": "Generate financial trend from payment records",
      "type": "feature",
      "description": "Implement financial trend calculation in RPC function. Query payment_records table grouped by date, calculate total revenue (sum of total_amount) and glosas/denials. Generate time series matching period parameter. Include weekend_bonus, night_shift_bonus, and holiday_bonus in revenue calculations.",
      "acceptance_criteria": [
        "Payment records grouped by date with proper date_trunc",
        "Revenue calculated as sum of payment_records.total_amount",
        "Glosas/denials extracted from payment metadata or calculated",
        "Returns array with label, receita, and glosas fields",
        "Handles cases where no payment records exist for dates"
      ],
      "passes": true
    },
    {
      "id": "F017",
      "title": "Calculate efficiency metrics from attendance data",
      "type": "feature",
      "description": "Implement efficiency trend calculation in RPC function. Calculate occupancy rate from shift_attendance table (filled shifts / total shifts * 100). Calculate average SLA/wait time from shift timing data. Group by date to create time series for period. Handle cases where shift_attendance data is sparse.",
      "acceptance_criteria": [
        "Occupancy calculated as (shifts with attendance / total shifts) * 100",
        "SLA calculated from average shift start delay or attendance metrics",
        "Returns time series with label, ocupacao, and sla fields",
        "Handles missing shift_attendance records gracefully",
        "Groups data by appropriate date intervals based on period"
      ],
      "passes": true
    },
    {
      "id": "F018",
      "title": "Generate top performers highlights from real data",
      "type": "feature",
      "description": "Implement highlights calculation in RPC function to show top performing medical staff. Query shifts joined with medical_staff and facilities, count shifts per staff member in period, calculate period-over-period variation. Return top 3-5 performers with name, specialty, unit, volume, and variation percentage.",
      "acceptance_criteria": [
        "Query returns top 3-5 medical staff by shift count in period",
        "Joins with medical_staff for name and specialty",
        "Joins with facilities for unit/facility name",
        "Calculates variation comparing to previous period",
        "Returns structure matching HighlightRow interface"
      ],
      "passes": true
    },
    {
      "id": "F019",
      "title": "Update ReportFilters with dynamic facility and specialty options",
      "type": "feature",
      "description": "Create API endpoint /api/reports/filter-options that queries Supabase for distinct facilities and medical staff specialties. Update ReportFilters component to fetch and populate dropdown options dynamically. Replace hardcoded filter options with real data from database.",
      "acceptance_criteria": [
        "API route /api/reports/filter-options created",
        "Endpoint queries facilities table for active facilities",
        "Endpoint queries medical_staff for distinct specialties",
        "ReportFilters component fetches options on mount",
        "Dropdowns populated with real facility names and specialties"
      ],
      "passes": true
    },
    {
      "id": "F020",
      "title": "Add organization-based RLS and filtering to reports",
      "type": "feature",
      "description": "Implement organization context filtering in reports. Update reports_dashboard_metrics to accept organization_id parameter. Apply RLS policies to ensure users only see data for their organization. Update frontend to pass current organization_id from OrganizationProvider context to API calls.",
      "acceptance_criteria": [
        "RPC function accepts p_organization_id parameter",
        "All queries filtered by organization_id from shifts, facilities, medical_staff",
        "Frontend passes organization_id from OrganizationProvider",
        "RLS policies verified for all queried tables",
        "Users cannot access reports from other organizations"
      ],
      "passes": true
    },
    {
      "id": "F021",
      "title": "Create calendar view database query function",
      "type": "feature",
      "description": "Create a Supabase RPC function or API endpoint to fetch shifts data formatted for calendar display. Query should join shifts table with medical_staff, facilities, and related tables to get complete shift details including doctor name, facility name, specialty, date, and time. Support filtering by date range, facility, and specialty. Return data structured for calendar rendering.",
      "acceptance_criteria": [
        "Database function or API endpoint created to fetch shifts with all related data",
        "Query includes joins for medical_staff (doctor info) and facilities",
        "Date range filtering implemented (start_date, end_date parameters)",
        "Optional filtering by facility_id and specialty implemented",
        "Response format optimized for calendar display (grouped by date)"
      ],
      "passes": true
    },
    {
      "id": "F022",
      "title": "Create shifts calendar data hook",
      "type": "feature",
      "description": "Create a custom React hook (useShiftsCalendar) to fetch and manage calendar data. Hook should handle loading states, error handling, filtering parameters, and data transformation. Use React Query or SWR for caching and automatic refetching. Transform API response into format suitable for calendar component consumption.",
      "acceptance_criteria": [
        "Custom hook created in src/hooks/useShiftsCalendar.ts",
        "Loading, error, and success states properly managed",
        "Filtering parameters (dateRange, facilityId, specialty) supported",
        "Data cached and refetched appropriately",
        "TypeScript interfaces defined for calendar data structure"
      ],
      "passes": true
    },
    {
      "id": "F023",
      "title": "Install and configure calendar library",
      "type": "feature",
      "description": "Install react-big-calendar or similar calendar library compatible with the tech stack. Configure with date-fns for date handling (already in project). Set up TypeScript types and create base calendar wrapper component with Portuguese locale. Apply Tailwind CSS styling to match project design system.",
      "acceptance_criteria": [
        "Calendar library installed (react-big-calendar or alternative)",
        "Library configured to use date-fns as date adapter",
        "Portuguese locale (pt-BR) configured for calendar",
        "Base CalendarWrapper component created with proper TypeScript types",
        "Tailwind CSS custom styles applied to match design system"
      ],
      "passes": true
    },
    {
      "id": "F024",
      "title": "Create ShiftsCalendar display component",
      "type": "feature",
      "description": "Build the main ShiftsCalendar component in src/components/organisms/ that renders the calendar with shifts data. Display each shift as an event showing doctor name and facility. Implement month, week, and day views. Add color coding by specialty or facility. Handle click events to trigger detail modal. Include loading skeleton and empty states.",
      "acceptance_criteria": [
        "ShiftsCalendar component created in src/components/organisms/",
        "Calendar displays shifts with doctor and facility information",
        "Month, week, and day views implemented and switchable",
        "Color coding applied (by specialty or facility)",
        "Click handlers implemented for shift events",
        "Loading skeleton and empty state UI included"
      ],
      "passes": true
    },
    {
      "id": "F025",
      "title": "Create ShiftDetailModal component",
      "type": "feature",
      "description": "Create a modal component to display detailed shift information when user clicks on a calendar event. Show complete details: doctor name, specialty, facility name, facility address, shift date, start/end time, status, and any notes. Use Radix UI Dialog primitive consistent with project patterns. Include close button and proper accessibility attributes.",
      "acceptance_criteria": [
        "ShiftDetailModal component created using Radix UI Dialog",
        "Displays all shift details: doctor, specialty, facility, date, time, status",
        "Facility address displayed if available",
        "Modal opens/closes smoothly with proper animations",
        "Proper ARIA labels and keyboard navigation (ESC to close)",
        "Styled with Tailwind CSS matching design system"
      ],
      "passes": true
    },
    {
      "id": "F026",
      "title": "Create calendar filter controls component",
      "type": "feature",
      "description": "Build CalendarFilters component with controls for filtering calendar view. Include date range picker (using existing date picker from shadcn/ui), facility dropdown, and specialty dropdown. Integrate with useShiftsCalendar hook to update calendar data. Add clear filters button. Style consistently with existing filter components in the project.",
      "acceptance_criteria": [
        "CalendarFilters component created in src/components/molecules/",
        "Date range picker implemented using shadcn/ui date picker",
        "Facility dropdown populated with user's accessible facilities",
        "Specialty dropdown with available specialties",
        "Clear filters button resets all filters to default",
        "Filters properly update calendar data through hook"
      ],
      "passes": true
    },
    {
      "id": "F027",
      "title": "Create Escalas (Shifts) calendar page",
      "type": "feature",
      "description": "Create the main Escalas page in src/app/dashboard/escalas/ that integrates ShiftsCalendar, CalendarFilters, and ShiftDetailModal components. Add page header with title 'Calendário de Escalas'. Implement proper layout using existing dashboard layout patterns. Add organization-based access control to ensure admin sees only their organization's shifts. Handle modal state management.",
      "acceptance_criteria": [
        "Escalas page created at src/app/dashboard/escalas/page.tsx",
        "Page header with 'Calendário de Escalas' title",
        "ShiftsCalendar, CalendarFilters integrated in proper layout",
        "Modal state properly managed (open/close with selected shift)",
        "Organization-based filtering enforced (RLS or client-side)",
        "Page responsive and matches dashboard design patterns"
      ],
      "passes": true
    },
    {
      "id": "F028",
      "title": "Add calendar navigation to dashboard menu",
      "type": "feature",
      "description": "Add 'Calendário de Escalas' navigation link to the dashboard sidebar/menu. Use appropriate Lucide React icon (Calendar or CalendarDays). Ensure link is only visible to admin users. Update navigation component to highlight active route when on calendar page. Position logically near other shift-related menu items.",
      "acceptance_criteria": [
        "Calendar navigation link added to dashboard menu",
        "Appropriate icon from Lucide React used",
        "Link only visible to users with admin role",
        "Active route highlighting works correctly",
        "Link positioned logically in menu structure"
      ],
      "passes": true
    },
    {
      "id": "B001",
      "title": "Fix calendar navigation controls disappearing when no shifts found",
      "type": "bugfix",
      "description": "When navigating to periods without scheduled shifts using the Previous/Next buttons in the Shifts Calendar (Calendário de Escalas), the empty state message 'Nenhum plantão encontrado' displays correctly, but all calendar navigation controls (Hoje, Anterior, Próximo, month/year selectors, and view mode buttons) disappear. This traps users on the empty state screen with no way to navigate back to periods that have shifts. The bug occurs in ShiftsCalendar.tsx lines 244-247 where returning CalendarEmptyState replaces the entire calendar component including the CalendarToolbar. The fix should display the empty state within the calendar while preserving all navigation controls.",
      "acceptance_criteria": [
        "Calendar navigation controls (Hoje, Anterior, Próximo) remain visible when no shifts are found",
        "Month and year selector dropdowns remain functional on empty state",
        "View mode buttons (Mês, Semana, Dia, Agenda) stay accessible when calendar is empty",
        "Empty state message 'Nenhum plantão encontrado' still displays within calendar area",
        "Users can navigate from empty periods back to dates with shifts using any navigation control",
        "All existing unit tests in hooks/__tests__/useShiftsCalendar.example.tsx continue to pass",
        "All e2e tests in e2e/calendar/ pass including navigation, view modes, and combined filters tests"
      ],
      "passes": true
    },
    {
      "id": "F029",
      "title": "Create SMTP configuration database schema and migration",
      "type": "feature",
      "description": "Create Supabase migration to add email_smtp_settings table with columns: organization_id (FK), smtp_host, smtp_port, smtp_user, smtp_password (encrypted), smtp_from_email, smtp_from_name, use_tls, is_enabled, created_at, updated_at. Add RLS policies to restrict access to admin users only. Include unique constraint on organization_id.",
      "acceptance_criteria": [
        "Migration file created in migrations/ directory",
        "email_smtp_settings table created with all required columns",
        "RLS policies implemented for admin-only access",
        "Foreign key relationship to organizations table established",
        "Unique constraint on organization_id enforced"
      ],
      "test_criteria": {
        "scenarios": [
          "Admin user can insert SMTP settings for their organization",
          "Non-admin user cannot access email_smtp_settings table",
          "Cannot create duplicate SMTP settings for same organization"
        ],
        "selectors": [],
        "assertions": [
          "Table exists in database schema",
          "RLS policies prevent unauthorized access",
          "Unique constraint prevents duplicate entries"
        ]
      },
      "passes": true
    },
    {
      "id": "F030",
      "title": "Create SMTP settings Zod validation schema",
      "type": "feature",
      "description": "Create Zod schema in src/schemas/smtp-settings.schema.ts for SMTP configuration validation. Include validation for smtp_host (required domain/IP), smtp_port (number 1-65535), smtp_user (required email), smtp_password (min 8 chars), smtp_from_email (valid email), smtp_from_name (optional string), use_tls (boolean), is_enabled (boolean). Export type SmtpSettingsFormData.",
      "acceptance_criteria": [
        "Zod schema created in src/schemas/smtp-settings.schema.ts",
        "All SMTP fields have appropriate validation rules",
        "Email fields validated with proper email format",
        "Port number validated within valid range (1-65535)",
        "TypeScript type exported from schema"
      ],
      "test_criteria": {
        "scenarios": [
          "Valid SMTP configuration passes schema validation",
          "Invalid email format triggers validation error",
          "Invalid port number triggers validation error"
        ],
        "selectors": [],
        "assertions": [
          "Schema exports SmtpSettingsFormData type",
          "Validation errors contain helpful messages",
          "All required fields are enforced"
        ]
      },
      "passes": true
    },
    {
      "id": "F031",
      "title": "Implement SMTP settings API endpoints (GET, POST, PATCH)",
      "type": "feature",
      "description": "Create API routes in src/app/api/smtp-settings/route.ts for GET (fetch current settings), POST (create settings), and PATCH (update settings). Implement server-side validation using Zod schema. Add admin authorization check. Encrypt smtp_password before storage using Supabase Vault or environment-based encryption key. Return sanitized data (no password in response).",
      "acceptance_criteria": [
        "GET /api/smtp-settings returns current organization SMTP settings",
        "POST /api/smtp-settings creates new SMTP configuration",
        "PATCH /api/smtp-settings updates existing configuration",
        "Admin authorization enforced on all endpoints",
        "smtp_password encrypted before database storage"
      ],
      "test_criteria": {
        "scenarios": [
          "GET request returns SMTP settings without password field",
          "POST request creates new settings with encrypted password",
          "PATCH request updates settings successfully",
          "Non-admin user receives 403 Forbidden response"
        ],
        "selectors": [],
        "assertions": [
          "API returns 200 status for valid requests",
          "Password never appears in API responses",
          "Validation errors return 400 status with details"
        ]
      },
      "passes": true
    },
    {
      "id": "F032",
      "title": "Create SMTP test connection endpoint",
      "type": "feature",
      "description": "Create API route POST /api/smtp-settings/test-connection to validate SMTP credentials by sending test email. Use nodemailer package to establish SMTP connection with provided credentials. Send test email to configured smtp_from_email. Return connection success/failure status with detailed error messages. Implement timeout handling (10s max).",
      "acceptance_criteria": [
        "POST /api/smtp-settings/test-connection endpoint created",
        "nodemailer package installed and configured",
        "Test email sent successfully with valid credentials",
        "Detailed error messages returned for connection failures",
        "Connection timeout enforced at 10 seconds"
      ],
      "test_criteria": {
        "scenarios": [
          "Valid SMTP credentials result in successful test email",
          "Invalid credentials return connection error",
          "Connection timeout triggers appropriate error message"
        ],
        "selectors": [],
        "assertions": [
          "API returns success status when email sent",
          "API returns error details when connection fails",
          "Request completes within timeout period"
        ]
      },
      "passes": true
    },
    {
      "id": "F033",
      "title": "Create SmtpSettingsForm component with all configuration fields",
      "type": "feature",
      "description": "Create SmtpSettingsForm component in src/components/organisms/ using React Hook Form and Zod schema. Include form fields: smtp_host (Input), smtp_port (Input type number), smtp_user (Input email), smtp_password (Input password with show/hide toggle), smtp_from_email (Input email), smtp_from_name (Input), use_tls (Switch), is_enabled (Switch). Add 'Test Connection' button. Implement loading states and error handling.",
      "acceptance_criteria": [
        "SmtpSettingsForm component created with all SMTP fields",
        "React Hook Form integrated with Zod validation",
        "Password field has show/hide toggle functionality",
        "Test Connection button triggers connection test",
        "Loading states displayed during form submission and testing"
      ],
      "test_criteria": {
        "scenarios": [
          "User can fill all SMTP configuration fields",
          "Form validation displays errors for invalid inputs",
          "Test Connection button sends test request",
          "Password visibility can be toggled on/off"
        ],
        "selectors": [
          "input[name='smtp_host']",
          "input[name='smtp_port']",
          "input[name='smtp_password']",
          "button:has-text('Test Connection')"
        ],
        "assertions": [
          "Form renders all input fields",
          "Validation errors appear below invalid fields",
          "Test Connection button is clickable when form valid"
        ]
      },
      "passes": true
    },
    {
      "id": "F034",
      "title": "Create useSmtpSettings hook for SMTP data management",
      "type": "feature",
      "description": "Create useSmtpSettings custom hook in src/hooks/useSmtpSettings.ts to manage SMTP settings state. Implement methods: fetchSettings (GET), saveSettings (POST/PATCH), testConnection. Use React Query for caching and loading states. Add toast notifications for success/error feedback. Handle organization context to fetch settings for current organization.",
      "acceptance_criteria": [
        "useSmtpSettings hook created in src/hooks/",
        "React Query integrated for data fetching and caching",
        "Methods implemented: fetchSettings, saveSettings, testConnection",
        "Toast notifications shown for all operations",
        "Organization context properly handled"
      ],
      "test_criteria": {
        "scenarios": [
          "Hook fetches SMTP settings on mount",
          "saveSettings triggers API call and updates cache",
          "testConnection displays success/error toast",
          "Loading states properly managed during operations"
        ],
        "selectors": [],
        "assertions": [
          "Hook exports all required methods",
          "React Query cache updates after mutations",
          "Toast notifications appear for user feedback"
        ]
      },
      "passes": true
    },
    {
      "id": "F035",
      "title": "Add Email Notifications section to /dashboard/configuracoes page",
      "type": "feature",
      "description": "Update existing /dashboard/configuracoes page to include new 'Notificações por E-mail' section. Add TabsList item for 'E-mail' tab. Create TabsContent with heading, description, and SmtpSettingsForm component. Add admin-only visibility check - show access denied message for non-admin users. Style section consistently with existing configuration tabs.",
      "acceptance_criteria": [
        "E-mail tab added to configuration page TabsList",
        "TabsContent displays Email Notifications section",
        "SmtpSettingsForm component rendered in tab content",
        "Admin-only access enforced with appropriate messaging",
        "Section styling consistent with other configuration tabs"
      ],
      "test_criteria": {
        "scenarios": [
          "Admin user navigates to /dashboard/configuracoes and sees E-mail tab",
          "Clicking E-mail tab displays SMTP configuration form",
          "Non-admin user sees access denied message instead of form",
          "Form saves and displays success notification"
        ],
        "selectors": [
          "[role='tab']:has-text('E-mail')",
          "[role='tabpanel'] >> text='Notificações por E-mail'",
          "form >> text='Configurações SMTP'"
        ],
        "assertions": [
          "E-mail tab is visible in navigation",
          "SMTP form appears when tab selected",
          "Admin check prevents unauthorized access"
        ]
      },
      "passes": true
    },
    {
      "id": "F036",
      "title": "Add SMTP settings e2e tests for configuration page",
      "type": "feature",
      "description": "Create e2e test file e2e/smtp-settings.spec.ts with comprehensive test coverage. Test scenarios: admin can view SMTP form, admin can save SMTP settings, test connection success/failure, non-admin cannot access form, validation errors display correctly, password encryption verified (password not in response). Use existing test patterns from e2e/clinicas-table.spec.ts.",
      "acceptance_criteria": [
        "e2e test file created at e2e/smtp-settings.spec.ts",
        "Test scenarios cover admin access, form submission, validation",
        "Test connection feature validated in e2e tests",
        "Non-admin access restriction tested",
        "Password encryption verified (no plain password in responses)"
      ],
      "test_criteria": {
        "scenarios": [
          "Admin user can access and submit SMTP configuration form",
          "Test connection button triggers connection validation",
          "Form validation prevents invalid submissions",
          "Non-admin user sees access denied message",
          "Saved settings persist and reload correctly"
        ],
        "selectors": [
          "[data-testid='smtp-settings-form']",
          "button:has-text('Test Connection')",
          "button:has-text('Salvar Configurações')"
        ],
        "assertions": [
          "All test scenarios pass successfully",
          "Form submission creates/updates database record",
          "Password never exposed in network responses"
        ]
      },
      "passes": true
    },
    {
      "id": "F037",
      "title": "Create medical staff detail view database query function",
      "type": "feature",
      "description": "Create RPC function or server-side query to fetch comprehensive medical staff details including personal info, specialties, facilities, shift history, performance metrics, and contact information. Implement in src/lib/supabase/ with proper organization filtering and RLS. Query should join medical_staff with related tables (facilities, specialties, shifts) to provide complete professional profile data.",
      "acceptance_criteria": [
        "Database query function created in src/lib/supabase/",
        "Function fetches medical staff by ID with all related data (specialties, facilities, shifts)",
        "Organization-based RLS filtering implemented correctly",
        "Function returns properly typed data matching Database types",
        "Query optimized with proper joins to avoid N+1 problems"
      ],
      "test_criteria": {
        "scenarios": [
          "Query returns complete medical staff details for valid ID",
          "Query respects organization boundaries (RLS)",
          "Query returns null for non-existent medical staff ID"
        ],
        "selectors": [],
        "assertions": [
          "Returned data includes all required fields (name, specialties, facilities, contact)",
          "Query executes within acceptable performance threshold (<500ms)",
          "Data is properly typed with TypeScript"
        ]
      },
      "passes": true
    },
    {
      "id": "F038",
      "title": "Create useMedicalStaffDetail hook for data fetching",
      "type": "feature",
      "description": "Implement custom React hook in src/hooks/useMedicalStaffDetail.ts to fetch and manage medical staff detail data. Hook should handle loading states, error states, refetching, and caching. Use Supabase real-time subscriptions for live updates. Export hook from src/hooks/index.ts following existing patterns.",
      "acceptance_criteria": [
        "useMedicalStaffDetail hook created in src/hooks/useMedicalStaffDetail.ts",
        "Hook manages loading, error, and data states",
        "Hook accepts medical staff ID as parameter",
        "Real-time subscription implemented for live data updates",
        "Hook exported from src/hooks/index.ts"
      ],
      "test_criteria": {
        "scenarios": [
          "Hook fetches data successfully on mount",
          "Hook handles loading state correctly",
          "Hook handles error state when fetch fails",
          "Hook updates data when real-time changes occur"
        ],
        "selectors": [],
        "assertions": [
          "Hook returns { data, isLoading, error, refetch } interface",
          "Loading state is true during fetch",
          "Error state populated when query fails"
        ]
      },
      "passes": true
    },
    {
      "id": "F039",
      "title": "Create MedicalStaffHeader atom component",
      "type": "feature",
      "description": "Create atomic component in src/components/atoms/MedicalStaffHeader.tsx to display professional's name, photo, primary specialty, and status badge. Component should accept props for avatar URL, name, specialty, and online/active status. Use shadcn/ui Avatar, Badge components. Implement skeleton loader variant for loading states. Follow atomic design principles.",
      "acceptance_criteria": [
        "MedicalStaffHeader component created in src/components/atoms/",
        "Component displays avatar, name, specialty, and status badge",
        "Skeleton loader variant implemented",
        "Component properly typed with TypeScript interface",
        "Component follows existing atomic design patterns"
      ],
      "test_criteria": {
        "scenarios": [
          "Component renders with valid data",
          "Component shows skeleton when in loading state",
          "Component handles missing avatar gracefully (shows initials)"
        ],
        "selectors": [
          "[data-testid='medical-staff-header']",
          "[data-testid='staff-avatar']",
          "[data-testid='staff-name']",
          "[data-testid='staff-specialty']"
        ],
        "assertions": [
          "Avatar displays image when URL provided",
          "Name and specialty text are visible",
          "Status badge shows correct color based on status"
        ]
      },
      "passes": false
    },
    {
      "id": "F040",
      "title": "Create MedicalStaffInfoCard molecule component",
      "type": "feature",
      "description": "Create molecule component in src/components/molecules/MedicalStaffInfoCard.tsx to display categorized information sections (Contact Info, Professional Details, Documents). Use shadcn/ui Card, Separator. Component should accept sections as props and render icon + label + value rows. Implement responsive grid layout. Support loading skeleton state.",
      "acceptance_criteria": [
        "MedicalStaffInfoCard component created in src/components/molecules/",
        "Component displays multiple information sections with icons",
        "Responsive grid layout implemented (1 column mobile, 2 columns desktop)",
        "Skeleton loader state implemented",
        "Uses Lucide React icons for visual enhancement"
      ],
      "test_criteria": {
        "scenarios": [
          "Component renders multiple information sections",
          "Component adapts layout for mobile and desktop viewports",
          "Component shows skeleton loaders during data fetch"
        ],
        "selectors": [
          "[data-testid='info-card']",
          "[data-testid='info-section']",
          "[data-testid='info-row']"
        ],
        "assertions": [
          "All provided sections render correctly",
          "Icons display next to each information row",
          "Card is responsive and adjusts to viewport size"
        ]
      },
      "passes": false
    },
    {
      "id": "F041",
      "title": "Create MedicalStaffShiftHistory molecule component",
      "type": "feature",
      "description": "Create molecule component in src/components/molecules/MedicalStaffShiftHistory.tsx to display recent shift history in a timeline or list format. Show shift date, facility, specialty, hours worked, and status. Use shadcn/ui Card, Badge, ScrollArea. Implement virtual scrolling for performance with large datasets. Support empty state when no shifts found.",
      "acceptance_criteria": [
        "MedicalStaffShiftHistory component created in src/components/molecules/",
        "Component displays shift history in chronological order (most recent first)",
        "Virtual scrolling implemented for performance",
        "Empty state component shown when no shifts available",
        "Each shift shows date, facility, specialty, hours, and status badge"
      ],
      "test_criteria": {
        "scenarios": [
          "Component renders list of shifts with all details",
          "Component shows empty state when no shifts exist",
          "Component handles large datasets efficiently with virtual scrolling"
        ],
        "selectors": [
          "[data-testid='shift-history']",
          "[data-testid='shift-item']",
          "[data-testid='shift-empty-state']"
        ],
        "assertions": [
          "Shifts are ordered by date (newest first)",
          "Status badges display correct colors",
          "Scrolling is smooth with 100+ shift records"
        ]
      },
      "passes": false
    },
    {
      "id": "F042",
      "title": "Create MedicalStaffPerformanceMetrics organism component",
      "type": "feature",
      "description": "Create organism component in src/components/organisms/MedicalStaffPerformanceMetrics.tsx to display performance statistics and charts. Show total shifts, total hours, facilities worked, attendance rate. Use Recharts for visual data representation (bar/line charts). Implement time range selector (last 30/90/365 days). Use shadcn/ui Card, Tabs for chart switching.",
      "acceptance_criteria": [
        "MedicalStaffPerformanceMetrics component created in src/components/organisms/",
        "Component displays key metrics: total shifts, hours, facilities, attendance rate",
        "Recharts integration with responsive charts (bar/line)",
        "Time range selector implemented (30/90/365 days)",
        "Loading and error states handled gracefully"
      ],
      "test_criteria": {
        "scenarios": [
          "Component renders all performance metrics correctly",
          "Charts update when time range is changed",
          "Charts are responsive and adapt to container width"
        ],
        "selectors": [
          "[data-testid='performance-metrics']",
          "[data-testid='metric-card']",
          "[data-testid='performance-chart']",
          "[data-testid='time-range-selector']"
        ],
        "assertions": [
          "All metric cards display numerical values",
          "Charts render without errors",
          "Time range selector updates chart data"
        ]
      },
      "passes": false
    },
    {
      "id": "F043",
      "title": "Create MedicalStaffDetailView page component",
      "type": "feature",
      "description": "Create page component in src/app/dashboard/corpo-clinico/[id]/page.tsx that composes all detail components into cohesive layout. Implement responsive grid layout with MedicalStaffHeader, MedicalStaffInfoCard, MedicalStaffShiftHistory, and MedicalStaffPerformanceMetrics. Use useMedicalStaffDetail hook for data fetching. Add back button to return to listing. Implement proper loading and error states.",
      "acceptance_criteria": [
        "Detail page created at src/app/dashboard/corpo-clinico/[id]/page.tsx",
        "Page composes all detail components in responsive grid layout",
        "useMedicalStaffDetail hook integrated for data fetching",
        "Back button navigates to medical staff listing page",
        "Loading skeleton and error states implemented"
      ],
      "test_criteria": {
        "scenarios": [
          "Page loads and displays all sections when valid ID provided",
          "Page shows loading skeletons during data fetch",
          "Page shows error message for invalid/non-existent ID",
          "Back button navigates to /dashboard/corpo-clinico"
        ],
        "selectors": [
          "[data-testid='medical-staff-detail-page']",
          "[data-testid='back-button']",
          "[data-testid='loading-skeleton']",
          "[data-testid='error-message']"
        ],
        "assertions": [
          "All components render in correct layout order",
          "Page is responsive on mobile, tablet, and desktop",
          "Navigation to detail page via URL parameter works"
        ]
      },
      "passes": false
    },
    {
      "id": "F044",
      "title": "Add 'View Details' action to medical staff table and navigation",
      "type": "feature",
      "description": "Modify existing medical staff table component to add 'Visualizar' option in row actions menu (DropdownMenu) and make staff name clickable to navigate to detail view. Update table actions to include Eye icon from Lucide React. Implement navigation using next/navigation router. Ensure consistent behavior across all table interaction points.",
      "acceptance_criteria": [
        "'Visualizar' option added to table row actions dropdown menu",
        "Medical staff name in table is clickable and navigates to detail page",
        "Eye icon from Lucide React used for 'Visualizar' action",
        "Navigation uses Next.js router with proper dynamic route",
        "Both name click and menu action navigate to same detail page"
      ],
      "test_criteria": {
        "scenarios": [
          "Clicking staff name navigates to detail page with correct ID",
          "Clicking 'Visualizar' in dropdown menu navigates to detail page",
          "Navigation preserves query parameters (filters, pagination)"
        ],
        "selectors": [
          "[data-testid='staff-name-link']",
          "[data-testid='row-actions-menu']",
          "[data-testid='view-details-action']"
        ],
        "assertions": [
          "Both navigation methods lead to /dashboard/corpo-clinico/[id]",
          "Staff name appears as clickable link with hover effect",
          "'Visualizar' option visible in dropdown menu"
        ]
      },
      "passes": false
    },
    {
      "id": "F045",
      "title": "Add e2e tests for medical staff detail view",
      "type": "feature",
      "description": "Create comprehensive e2e test file in e2e/tests/medical-staff-detail.spec.ts to verify detail page functionality. Test navigation from table (name click and menu action), data rendering, component interactions, loading states, error handling, and back navigation. Use existing Playwright fixtures and test helpers. Verify responsive behavior and accessibility.",
      "acceptance_criteria": [
        "E2E test file created at e2e/tests/medical-staff-detail.spec.ts",
        "Tests verify navigation from table to detail page (both methods)",
        "Tests verify all components render with correct data",
        "Tests verify loading states and error handling",
        "Tests verify back button navigation to listing page"
      ],
      "test_criteria": {
        "scenarios": [
          "User clicks staff name in table and sees detail page",
          "User clicks 'Visualizar' in menu and sees detail page",
          "Detail page displays all information sections correctly",
          "Performance metrics charts render and are interactive",
          "Back button returns user to medical staff listing"
        ],
        "selectors": [
          "[data-testid='staff-name-link']",
          "[data-testid='view-details-action']",
          "[data-testid='medical-staff-detail-page']",
          "[data-testid='back-button']"
        ],
        "assertions": [
          "Navigation to detail page completes successfully",
          "All page sections are visible and contain data",
          "Back navigation returns to listing with preserved state"
        ]
      },
      "passes": false
    }
  ]
}