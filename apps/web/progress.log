[2025-12-12T17:38:19] [F014] Calculate real summary metrics from database - COMPLETED
- Implemented real total attendances calculation from shifts table count (current: 25 accepted shifts)
- Replaced coverage rate proxy with actual occupancy calculation from shift_attendance table (check-in AND check-out records)
- Occupancy formula: (Completed attendances / Total accepted shifts) × 100
- Maintained revenue calculation from payment_records.total_amount SUM
- Implemented glosa/denial rate calculation from payment_records.calculation_metadata->>'glosa_amount'
- Glosa formula: (Total glosa amount / Total billed) × 100
- Added period-over-period delta calculations for ALL metrics comparing current vs previous equivalent period
- Attendance delta: ((current accepted - previous accepted) / previous accepted) × 100
- Occupancy delta: ((current occupancy - previous occupancy) / previous occupancy) × 100
- Revenue delta: ((current revenue - previous revenue) / previous revenue) × 100
- Added average rate delta calculation for hourly/shift rates
- Updated summary metrics helper text to reflect data sources ("Baseado em check-in/check-out", "Baseado em registros de pagamento")
- Updated efficiency trend to use real shift_attendance data instead of coverage proxy
- Updated financial trend to extract real glosas from payment_records metadata
- All calculations handle NULL/empty data gracefully with COALESCE and NULLIF
- Handles edge cases: division by zero, no previous period data (returns 100% or 0% appropriately)
- Changed 4th metric from "Taxa média por hora" to "Taxa de glosa" to match actual business needs
- Applied migration 20251212_calculate_real_summary_metrics.sql via Supabase MCP successfully
- Verified all calculations with real database queries (25 shifts, 0% occupancy, R$ 0 revenue, 0% glosa rate)
- All acceptance criteria met and tested

[2024-12-12T17:32:52] [F013] Implement facility-based filtering in report metrics - COMPLETED
- Added facility_id validation to reports_dashboard_metrics RPC function
- Validates facility exists in facilities table when p_unit != 'todas'
- Raises helpful exception with hint when invalid facility_id is provided
- Confirmed facility filtering already working correctly across all queries (shifts, payment_records, trends, highlights)
- Added comprehensive documentation comments explaining facility filtering logic
- Tested all scenarios: 'todas' (all facilities), specific facility_id, invalid facility_id, combined specialty+facility filters
- Verified highlights section correctly shows only staff from selected facility
- Applied migration via Supabase MCP successfully
- All acceptance criteria met and tested with real database queries

[2024-12-12T$(date +%H:%M:%S)] [F012] Implement specialty-based filtering in report metrics - COMPLETED
- Extended reports_dashboard_metrics RPC function to filter by medical_staff.specialty
- Added COALESCE handling for NULL specialty values (defaults to 'geral')
- Fixed specialty_counts CTE to respect p_specialty parameter filter
- Fixed highlights query column references to use proper aliases
- Fixed RANDOM() type casting issue with NUMERIC conversion
- Verified filtering works correctly: 'todas' returns all data, specific specialty filters properly
- Applied migration via Supabase MCP successfully
- All acceptance criteria met and tested with real database queries
